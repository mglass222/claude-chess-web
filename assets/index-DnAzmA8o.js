var hs=Object.defineProperty;var cs=(h,t,e)=>t in h?hs(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var A=(h,t,e)=>cs(h,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();function us(h){return h!==null?{comment:h,variations:[]}:{variations:[]}}function ds(h,t,e,s,i){const n={move:h,variations:i};return t&&(n.suffix=t),e&&(n.nag=e),s!==null&&(n.comment=s),n}function fs(...h){const[t,...e]=h;let s=t;for(const i of e)i!==null&&(s.variations=[i,...i.variations],i.variations=[],s=i);return t}function ps(h,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){const s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:h,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function gs(h,t){function e(){this.constructor=h}e.prototype=t.prototype,h.prototype=new e}function Q(h,t,e,s){var i=Error.call(this,h);return Object.setPrototypeOf&&Object.setPrototypeOf(i,Q.prototype),i.expected=t,i.found=e,i.location=s,i.name="SyntaxError",i}gs(Q,Error);function me(h,t,e){return e=e||" ",h.length>t?h:(t-=h.length,e+=e.repeat(t),h+e.slice(0,t))}Q.prototype.format=function(h){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<h.length;s++)if(h[s].source===this.location.source){e=h[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,n=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,a=this.location.source+":"+n.line+":"+n.column;if(e){var r=this.location.end,l=me("",n.line.toString().length," "),f=e[i.line-1],g=i.line===r.line?r.column:f.length+1,_=g-i.column||1;t+=`
 --> `+a+`
`+l+` |
`+n.line+" | "+f+`
`+l+" | "+me("",i.column-1," ")+me("",_,"^")}else t+=`
 at `+a}return t};Q.buildMessage=function(h,t){var e={literal:function(f){return'"'+i(f.text)+'"'},class:function(f){var g=f.parts.map(function(_){return Array.isArray(_)?n(_[0])+"-"+n(_[1]):n(_)});return"["+(f.inverted?"^":"")+g.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(f){return f.description}};function s(f){return f.charCodeAt(0).toString(16).toUpperCase()}function i(f){return f.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function n(f){return f.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function a(f){return e[f.type](f)}function r(f){var g=f.map(a),_,p;if(g.sort(),g.length>0){for(_=1,p=1;_<g.length;_++)g[_-1]!==g[_]&&(g[p]=g[_],p++);g.length=p}switch(g.length){case 1:return g[0];case 2:return g[0]+" or "+g[1];default:return g.slice(0,-1).join(", ")+", or "+g[g.length-1]}}function l(f){return f?'"'+i(f)+'"':"end of input"}return"Expected "+r(h)+" but "+l(t)+" found."};function ms(h,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,i={pgn:ze},n=ze,a="[",r='"',l="]",f=".",g="O-O-O",_="O-O",p="0-0-0",k="0-0",v="$",M="{",x="}",G=";",ue="(",de=")",xe="1-0",Ae="0-1",Me="1/2-1/2",lt="*",fe=/^[a-zA-Z]/,Te=/^[^"]/,ee=/^[0-9]/,Ie=/^[.]/,Ne=/^[a-zA-Z1-8\-=]/,ht=/^[+#]/,Le=/^[!?]/,Pe=/^[^}]/,$e=/^[^\r\n]/,Be=/^[ \t\r\n]/,ct=D("tag pair"),ut=N("[",!1),Oe=N('"',!1),dt=N("]",!1),ft=D("tag name"),pe=R([["a","z"],["A","Z"]],!1,!1),pt=D("tag value"),De=R(['"'],!0,!1),gt=D("move number"),te=R([["0","9"]],!1,!1),mt=N(".",!1),qe=R(["."],!1,!1),_t=D("standard algebraic notation"),vt=N("O-O-O",!1),yt=N("O-O",!1),bt=N("0-0-0",!1),Ct=N("0-0",!1),Re=R([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Et=R(["+","#"],!1,!1),wt=D("suffix annotation"),Ge=R(["!","?"],!1,!1),kt=D("NAG"),St=N("$",!1),xt=D("brace comment"),At=N("{",!1),Fe=R(["}"],!0,!1),Mt=N("}",!1),Tt=D("rest of line comment"),It=N(";",!1),He=R(["\r",`
`],!0,!1),Nt=D("variation"),Lt=N("(",!1),Pt=N(")",!1),$t=D("game termination marker"),Bt=N("1-0",!1),Ot=N("0-1",!1),Dt=N("1/2-1/2",!1),qt=N("*",!1),Rt=D("whitespace"),Ve=R([" ","	","\r",`
`],!1,!1),Gt=function(o,u){return ps(o,u)},Ft=function(o){return Object.fromEntries(o)},Ht=function(o,u){return[o,u]},Vt=function(o,u){return{root:o,marker:u}},Kt=function(o,u){return fs(us(o),...u.flat())},Ut=function(o,u,d,b,C){return ds(o,u,d,b,C)},zt=function(o){return o},Wt=function(o){return o.replace(/[\r\n]+/g," ")},jt=function(o){return o.trim()},Qt=function(o){return o},Yt=function(o,u){return{result:o,comment:u}},c=t.peg$currPos|0,j=[{line:1,column:1}],q=c,se=t.peg$maxFailExpected||[],m=t.peg$silentFails|0,Y;if(t.startRule){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');n=i[t.startRule]}function N(o,u){return{type:"literal",text:o,ignoreCase:u}}function R(o,u,d){return{type:"class",parts:o,inverted:u,ignoreCase:d}}function Xt(){return{type:"end"}}function D(o){return{type:"other",description:o}}function Ke(o){var u=j[o],d;if(u)return u;if(o>=j.length)d=j.length-1;else for(d=o;!j[--d];);for(u=j[d],u={line:u.line,column:u.column};d<o;)h.charCodeAt(d)===10?(u.line++,u.column=1):u.column++,d++;return j[o]=u,u}function Ue(o,u,d){var b=Ke(o),C=Ke(u),S={source:s,start:{offset:o,line:b.line,column:b.column},end:{offset:u,line:C.line,column:C.column}};return S}function y(o){c<q||(c>q&&(q=c,se=[]),se.push(o))}function Jt(o,u,d){return new Q(Q.buildMessage(o,u),o,u,d)}function ze(){var o,u,d;return o=c,u=Zt(),d=ss(),o=Gt(u,d),o}function Zt(){var o,u,d;for(o=c,u=[],d=We();d!==e;)u.push(d),d=We();return d=B(),o=Ft(u),o}function We(){var o,u,d,b,C,S,U;return m++,o=c,B(),h.charCodeAt(c)===91?(u=a,c++):(u=e,m===0&&y(ut)),u!==e?(B(),d=es(),d!==e?(B(),h.charCodeAt(c)===34?(b=r,c++):(b=e,m===0&&y(Oe)),b!==e?(C=ts(),h.charCodeAt(c)===34?(S=r,c++):(S=e,m===0&&y(Oe)),S!==e?(B(),h.charCodeAt(c)===93?(U=l,c++):(U=e,m===0&&y(dt)),U!==e?o=Ht(d,C):(c=o,o=e)):(c=o,o=e)):(c=o,o=e)):(c=o,o=e)):(c=o,o=e),m--,o===e&&m===0&&y(ct),o}function es(){var o,u,d;if(m++,o=c,u=[],d=h.charAt(c),fe.test(d)?c++:(d=e,m===0&&y(pe)),d!==e)for(;d!==e;)u.push(d),d=h.charAt(c),fe.test(d)?c++:(d=e,m===0&&y(pe));else u=e;return u!==e?o=h.substring(o,c):o=u,m--,o===e&&(u=e,m===0&&y(ft)),o}function ts(){var o,u,d;for(m++,o=c,u=[],d=h.charAt(c),Te.test(d)?c++:(d=e,m===0&&y(De));d!==e;)u.push(d),d=h.charAt(c),Te.test(d)?c++:(d=e,m===0&&y(De));return o=h.substring(o,c),m--,u=e,m===0&&y(pt),o}function ss(){var o,u,d;return o=c,u=je(),B(),d=ls(),d===e&&(d=null),B(),o=Vt(u,d),o}function je(){var o,u,d,b;for(o=c,u=ge(),u===e&&(u=null),d=[],b=Qe();b!==e;)d.push(b),b=Qe();return o=Kt(u,d),o}function Qe(){var o,u,d,b,C,S,U,ie;if(o=c,B(),is(),B(),u=ns(),u!==e){for(d=as(),d===e&&(d=null),b=[],C=Ye();C!==e;)b.push(C),C=Ye();for(C=B(),S=ge(),S===e&&(S=null),U=[],ie=Xe();ie!==e;)U.push(ie),ie=Xe();o=Ut(u,d,b,S,U)}else c=o,o=e;return o}function is(){var o,u,d,b,C,S;for(m++,o=c,u=[],d=h.charAt(c),ee.test(d)?c++:(d=e,m===0&&y(te));d!==e;)u.push(d),d=h.charAt(c),ee.test(d)?c++:(d=e,m===0&&y(te));if(h.charCodeAt(c)===46?(d=f,c++):(d=e,m===0&&y(mt)),d!==e){for(b=B(),C=[],S=h.charAt(c),Ie.test(S)?c++:(S=e,m===0&&y(qe));S!==e;)C.push(S),S=h.charAt(c),Ie.test(S)?c++:(S=e,m===0&&y(qe));u=[u,d,b,C],o=u}else c=o,o=e;return m--,o===e&&(u=e,m===0&&y(gt)),o}function ns(){var o,u,d,b,C,S;if(m++,o=c,u=c,h.substr(c,5)===g?(d=g,c+=5):(d=e,m===0&&y(vt)),d===e&&(h.substr(c,3)===_?(d=_,c+=3):(d=e,m===0&&y(yt)),d===e&&(h.substr(c,5)===p?(d=p,c+=5):(d=e,m===0&&y(bt)),d===e&&(h.substr(c,3)===k?(d=k,c+=3):(d=e,m===0&&y(Ct)),d===e))))if(d=c,b=h.charAt(c),fe.test(b)?c++:(b=e,m===0&&y(pe)),b!==e){if(C=[],S=h.charAt(c),Ne.test(S)?c++:(S=e,m===0&&y(Re)),S!==e)for(;S!==e;)C.push(S),S=h.charAt(c),Ne.test(S)?c++:(S=e,m===0&&y(Re));else C=e;C!==e?(b=[b,C],d=b):(c=d,d=e)}else c=d,d=e;return d!==e?(b=h.charAt(c),ht.test(b)?c++:(b=e,m===0&&y(Et)),b===e&&(b=null),d=[d,b],u=d):(c=u,u=e),u!==e?o=h.substring(o,c):o=u,m--,o===e&&(u=e,m===0&&y(_t)),o}function as(){var o,u,d;for(m++,o=c,u=[],d=h.charAt(c),Le.test(d)?c++:(d=e,m===0&&y(Ge));d!==e;)u.push(d),u.length>=2?d=e:(d=h.charAt(c),Le.test(d)?c++:(d=e,m===0&&y(Ge)));return u.length<1?(c=o,o=e):o=u,m--,o===e&&(u=e,m===0&&y(wt)),o}function Ye(){var o,u,d,b,C;if(m++,o=c,B(),h.charCodeAt(c)===36?(u=v,c++):(u=e,m===0&&y(St)),u!==e){if(d=c,b=[],C=h.charAt(c),ee.test(C)?c++:(C=e,m===0&&y(te)),C!==e)for(;C!==e;)b.push(C),C=h.charAt(c),ee.test(C)?c++:(C=e,m===0&&y(te));else b=e;b!==e?d=h.substring(d,c):d=b,d!==e?o=zt(d):(c=o,o=e)}else c=o,o=e;return m--,o===e&&m===0&&y(kt),o}function ge(){var o;return o=rs(),o===e&&(o=os()),o}function rs(){var o,u,d,b,C;if(m++,o=c,h.charCodeAt(c)===123?(u=M,c++):(u=e,m===0&&y(At)),u!==e){for(d=c,b=[],C=h.charAt(c),Pe.test(C)?c++:(C=e,m===0&&y(Fe));C!==e;)b.push(C),C=h.charAt(c),Pe.test(C)?c++:(C=e,m===0&&y(Fe));d=h.substring(d,c),h.charCodeAt(c)===125?(b=x,c++):(b=e,m===0&&y(Mt)),b!==e?o=Wt(d):(c=o,o=e)}else c=o,o=e;return m--,o===e&&(u=e,m===0&&y(xt)),o}function os(){var o,u,d,b,C;if(m++,o=c,h.charCodeAt(c)===59?(u=G,c++):(u=e,m===0&&y(It)),u!==e){for(d=c,b=[],C=h.charAt(c),$e.test(C)?c++:(C=e,m===0&&y(He));C!==e;)b.push(C),C=h.charAt(c),$e.test(C)?c++:(C=e,m===0&&y(He));d=h.substring(d,c),o=jt(d)}else c=o,o=e;return m--,o===e&&(u=e,m===0&&y(Tt)),o}function Xe(){var o,u,d,b;return m++,o=c,B(),h.charCodeAt(c)===40?(u=ue,c++):(u=e,m===0&&y(Lt)),u!==e?(d=je(),d!==e?(B(),h.charCodeAt(c)===41?(b=de,c++):(b=e,m===0&&y(Pt)),b!==e?o=Qt(d):(c=o,o=e)):(c=o,o=e)):(c=o,o=e),m--,o===e&&m===0&&y(Nt),o}function ls(){var o,u,d;return m++,o=c,h.substr(c,3)===xe?(u=xe,c+=3):(u=e,m===0&&y(Bt)),u===e&&(h.substr(c,3)===Ae?(u=Ae,c+=3):(u=e,m===0&&y(Ot)),u===e&&(h.substr(c,7)===Me?(u=Me,c+=7):(u=e,m===0&&y(Dt)),u===e&&(h.charCodeAt(c)===42?(u=lt,c++):(u=e,m===0&&y(qt))))),u!==e?(B(),d=ge(),d===e&&(d=null),o=Yt(u,d)):(c=o,o=e),m--,o===e&&(u=e,m===0&&y($t)),o}function B(){var o,u;for(m++,o=[],u=h.charAt(c),Be.test(u)?c++:(u=e,m===0&&y(Ve));u!==e;)o.push(u),u=h.charAt(c),Be.test(u)?c++:(u=e,m===0&&y(Ve));return m--,u=e,m===0&&y(Rt),o}if(Y=n(),t.peg$library)return{peg$result:Y,peg$currPos:c,peg$FAILED:e,peg$maxFailExpected:se,peg$maxFailPos:q};if(Y!==e&&c===h.length)return Y;throw Y!==e&&c<h.length&&y(Xt()),Jt(se,q<h.length?h.charAt(q):null,q<h.length?Ue(q,q+1):Ue(q,q))}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const le=0xffffffffffffffffn;function _e(h,t){return(h<<t|h>>64n-t)&0xffffffffffffffffn}function Je(h,t){return h*t&le}function _s(h){return function(){let t=BigInt(h&le),e=BigInt(h>>64n&le);const s=Je(_e(Je(t,5n),7n),9n);return e^=t,t=(_e(t,24n)^e^e<<16n)&le,e=_e(e,37n),h=e<<64n|t,s}}const ce=_s(0xa187eb39cdcaed8f31c4b365b102e01en),vs=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>ce()))),ys=Array.from({length:8},()=>ce()),bs=Array.from({length:16},()=>ce()),ve=ce(),$="w",O="b",T="p",ke="n",he="b",J="r",K="q",I="k",ye="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class ne{constructor(t,e){A(this,"color");A(this,"from");A(this,"to");A(this,"piece");A(this,"captured");A(this,"promotion");A(this,"flags");A(this,"san");A(this,"lan");A(this,"before");A(this,"after");const{color:s,piece:i,from:n,to:a,flags:r,captured:l,promotion:f}=e,g=L(n),_=L(a);this.color=s,this.piece=i,this.from=g,this.to=_,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=g+_,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(const p in w)w[p]&r&&(this.flags+=z[p]);l&&(this.captured=l),f&&(this.promotion=f,this.lan+=f)}isCapture(){return this.flags.indexOf(z.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(z.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(z.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(z.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(z.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(z.BIG_PAWN)>-1}}const P=-1,z={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},w={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},Se={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Cs={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Es={...Se,...Cs},E={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},be={b:[16,32,17,15],w:[-16,-32,-17,-15]},Ze={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},ws=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],ks=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Ss={p:1,n:2,b:4,r:8,q:16,k:32},xs="pnbrqkPNBRQK",et=[ke,he,J,K],As=7,Ms=6,Ts=1,Is=0,ae={[I]:w.KSIDE_CASTLE,[K]:w.QSIDE_CASTLE},H={w:[{square:E.a1,flag:w.QSIDE_CASTLE},{square:E.h1,flag:w.KSIDE_CASTLE}],b:[{square:E.a8,flag:w.QSIDE_CASTLE},{square:E.h8,flag:w.KSIDE_CASTLE}]},Ns={b:Ts,w:Ms},Ce="--";function W(h){return h>>4}function Z(h){return h&15}function at(h){return"0123456789".indexOf(h)!==-1}function L(h){const t=Z(h),e=W(h);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function X(h){return h===$?O:$}function Ls(h){const t=h.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let a=0;a<i.length;a++){let r=0,l=!1;for(let f=0;f<i[a].length;f++)if(at(i[a][f])){if(l)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};r+=parseInt(i[a][f],10),l=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[a][f]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};r+=1,l=!1}if(r!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const n=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:a,regex:r}of n){if(!r.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${a} king`};if((t[0].match(r)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${a} kings`}}return Array.from(i[0]+i[7]).some(a=>a.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Ps(h,t){const e=h.from,s=h.to,i=h.piece;let n=0,a=0,r=0;for(let l=0,f=t.length;l<f;l++){const g=t[l].from,_=t[l].to,p=t[l].piece;i===p&&e!==g&&s===_&&(n++,W(e)===W(g)&&a++,Z(e)===Z(g)&&r++)}return n>0?a>0&&r>0?L(e):r>0?L(e).charAt(1):L(e).charAt(0):""}function V(h,t,e,s,i,n=void 0,a=w.NORMAL){const r=W(s);if(i===T&&(r===As||r===Is))for(let l=0;l<et.length;l++){const f=et[l];h.push({color:t,from:e,to:s,piece:i,captured:n,promotion:f,flags:a|w.PROMOTION})}else h.push({color:t,from:e,to:s,piece:i,captured:n,flags:a})}function tt(h){let t=h.charAt(0);return t>="a"&&t<="h"?h.match(/[a-h]\d.*[a-h]\d/)?void 0:T:(t=t.toLowerCase(),t==="o"?I:t)}function Ee(h){return h.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class rt{constructor(t=ye,{skipValidation:e=!1}={}){A(this,"_board",new Array(128));A(this,"_turn",$);A(this,"_header",{});A(this,"_kings",{w:P,b:P});A(this,"_epSquare",-1);A(this,"_halfMoves",0);A(this,"_moveNumber",0);A(this,"_history",[]);A(this,"_comments",{});A(this,"_castling",{w:0,b:0});A(this,"_hash",0n);A(this,"_positionCount",new Map);this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:P,b:P},this._turn=$,this._castling={w:0,b:0},this._epSquare=P,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...Es},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let i=t.split(/\s+/);if(i.length>=2&&i.length<6){const r=["-","-","0","1"];t=i.concat(r.slice(-(6-i.length))).join(" ")}if(i=t.split(/\s+/),!e){const{ok:r,error:l}=Ls(t);if(!r)throw new Error(l)}const n=i[0];let a=0;this.clear({preserveHeaders:s});for(let r=0;r<n.length;r++){const l=n.charAt(r);if(l==="/")a+=8;else if(at(l))a+=parseInt(l,10);else{const f=l<"a"?$:O;this._put({type:l.toLowerCase(),color:f},L(a)),a++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=w.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=w.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=w.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=w.QSIDE_CASTLE),this._epSquare=i[3]==="-"?P:E[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){var a,r;let e=0,s="";for(let l=E.a8;l<=E.h1;l++){if(this._board[l]){e>0&&(s+=e,e=0);const{color:f,type:g}=this._board[l];s+=f===$?g.toUpperCase():g.toLowerCase()}else e++;l+1&136&&(e>0&&(s+=e),l!==E.h1&&(s+="/"),e=0,l+=8)}let i="";this._castling[$]&w.KSIDE_CASTLE&&(i+="K"),this._castling[$]&w.QSIDE_CASTLE&&(i+="Q"),this._castling[O]&w.KSIDE_CASTLE&&(i+="k"),this._castling[O]&w.QSIDE_CASTLE&&(i+="q"),i=i||"-";let n="-";if(this._epSquare!==P)if(t)n=L(this._epSquare);else{const l=this._epSquare+(this._turn===$?16:-16),f=[l+1,l-1];for(const g of f){if(g&136)continue;const _=this._turn;if(((a=this._board[g])==null?void 0:a.color)===_&&((r=this._board[g])==null?void 0:r.type)===T){this._makeMove({color:_,from:g,to:this._epSquare,piece:T,captured:T,flags:w.EP_CAPTURE});const p=!this._isKingAttacked(_);if(this._undoMove(),p){n=L(this._epSquare);break}}}}return[s,this._turn,i,n,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:e,type:s}=this._board[t],i={w:0,b:1}[e],n={p:0,n:1,b:2,r:3,q:4,k:5}[s];return vs[i][n][t]}_epKey(){return this._epSquare===P?0n:ys[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return bs[t]}_computeHash(){let t=0n;for(let e=E.a8;e<=E.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=ve),t}_updateSetup(t){this._history.length>0||(t!==ye?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(ye)}get(t){return this._board[E[t]]}findPiece(t){var s;const e=[];for(let i=E.a8;i<=E.h1;i++){if(i&136){i+=7;continue}!this._board[i]||((s=this._board[i])==null?void 0:s.color)!==t.color||this._board[i].color===t.color&&this._board[i].type===t.type&&e.push(L(i))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if(xs.indexOf(t.toLowerCase())===-1||!(s in E))return!1;const i=E[s];if(t==I&&!(this._kings[e]==P||this._kings[e]==i))return!1;const n=this._board[i];return n&&n.type===I&&(this._kings[n.color]=P),this._set(i,{type:t,color:e}),t===I&&(this._kings[e]=i),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const e=this.get(t);return this._clear(E[t]),e&&e.type===I&&(this._kings[e.color]=P),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){var s,i,n,a,r,l,f,g,_,p,k,v;this._hash^=this._castlingKey();const t=((s=this._board[E.e1])==null?void 0:s.type)===I&&((i=this._board[E.e1])==null?void 0:i.color)===$,e=((n=this._board[E.e8])==null?void 0:n.type)===I&&((a=this._board[E.e8])==null?void 0:a.color)===O;(!t||((r=this._board[E.a1])==null?void 0:r.type)!==J||((l=this._board[E.a1])==null?void 0:l.color)!==$)&&(this._castling.w&=-65),(!t||((f=this._board[E.h1])==null?void 0:f.type)!==J||((g=this._board[E.h1])==null?void 0:g.color)!==$)&&(this._castling.w&=-33),(!e||((_=this._board[E.a8])==null?void 0:_.type)!==J||((p=this._board[E.a8])==null?void 0:p.color)!==O)&&(this._castling.b&=-65),(!e||((k=this._board[E.h8])==null?void 0:k.type)!==J||((v=this._board[E.h8])==null?void 0:v.color)!==O)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){var n,a;if(this._epSquare===P)return;const t=this._epSquare+(this._turn===$?-16:16),e=this._epSquare+(this._turn===$?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||((n=this._board[e])==null?void 0:n.color)!==X(this._turn)||((a=this._board[e])==null?void 0:a.type)!==T){this._hash^=this._epKey(),this._epSquare=P;return}const i=r=>{var l,f;return!(r&136)&&((l=this._board[r])==null?void 0:l.color)===this._turn&&((f=this._board[r])==null?void 0:f.type)===T};s.some(i)||(this._hash^=this._epKey(),this._epSquare=P)}_attacked(t,e,s){const i=[];for(let n=E.a8;n<=E.h1;n++){if(n&136){n+=7;continue}if(this._board[n]===void 0||this._board[n].color!==t)continue;const a=this._board[n],r=n-e;if(r===0)continue;const l=r+119;if(ws[l]&Ss[a.type]){if(a.type===T){if(r>0&&a.color===$||r<=0&&a.color===O)if(s)i.push(L(n));else return!0;continue}if(a.type==="n"||a.type==="k")if(s){i.push(L(n));continue}else return!0;const f=ks[l];let g=n+f,_=!1;for(;g!==e;){if(this._board[g]!=null){_=!0;break}g+=f}if(!_)if(s){i.push(L(n));continue}else return!0}}return s?i:!1}attackers(t,e){return e?this._attacked(e,E[t],!0):this._attacked(this._turn,E[t],!0)}_isKingAttacked(t){const e=this._kings[t];return e===-1?!1:this._attacked(X(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,E[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},e=[];let s=0,i=0;for(let n=E.a8;n<=E.h1;n++){if(i=(i+1)%2,n&136){n+=7;continue}const a=this._board[n];a&&(t[a.type]=a.type in t?t[a.type]+1:1,a.type===he&&e.push(i),s++)}if(s===2)return!0;if(s===3&&(t[he]===1||t[ke]===1))return!0;if(s===t[he]+2){let n=0;const a=e.length;for(let r=0;r<a;r++)n+=e[r];if(n===0||n===a)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){const i=this._moves({square:e,piece:s});return t?i.map(n=>new ne(this,n)):i.map(n=>this._moveToSan(n,i))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){var k;const i=s?s.toLowerCase():void 0,n=e==null?void 0:e.toLowerCase(),a=[],r=this._turn,l=X(r);let f=E.a8,g=E.h1,_=!1;if(i)if(i in E)f=g=E[i],_=!0;else return[];for(let v=f;v<=g;v++){if(v&136){v+=7;continue}if(!this._board[v]||this._board[v].color===l)continue;const{type:M}=this._board[v];let x;if(M===T){if(n&&n!==M)continue;x=v+be[r][0],this._board[x]||(V(a,r,v,x,T),x=v+be[r][1],Ns[r]===W(v)&&!this._board[x]&&V(a,r,v,x,T,void 0,w.BIG_PAWN));for(let G=2;G<4;G++)x=v+be[r][G],!(x&136)&&(((k=this._board[x])==null?void 0:k.color)===l?V(a,r,v,x,T,this._board[x].type,w.CAPTURE):x===this._epSquare&&V(a,r,v,x,T,T,w.EP_CAPTURE))}else{if(n&&n!==M)continue;for(let G=0,ue=Ze[M].length;G<ue;G++){const de=Ze[M][G];for(x=v;x+=de,!(x&136);){if(!this._board[x])V(a,r,v,x,M);else{if(this._board[x].color===r)break;V(a,r,v,x,M,this._board[x].type,w.CAPTURE);break}if(M===ke||M===I)break}}}}if((n===void 0||n===I)&&(!_||g===this._kings[r])){if(this._castling[r]&w.KSIDE_CASTLE){const v=this._kings[r],M=v+2;!this._board[v+1]&&!this._board[M]&&!this._attacked(l,this._kings[r])&&!this._attacked(l,v+1)&&!this._attacked(l,M)&&V(a,r,this._kings[r],M,I,void 0,w.KSIDE_CASTLE)}if(this._castling[r]&w.QSIDE_CASTLE){const v=this._kings[r],M=v-2;!this._board[v-1]&&!this._board[v-2]&&!this._board[v-3]&&!this._attacked(l,this._kings[r])&&!this._attacked(l,v-1)&&!this._attacked(l,M)&&V(a,r,this._kings[r],M,I,void 0,w.QSIDE_CASTLE)}}if(!t||this._kings[r]===-1)return a;const p=[];for(let v=0,M=a.length;v<M;v++)this._makeMove(a[v]),this._isKingAttacked(r)||p.push(a[v]),this._undoMove();return p}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(Ce,e);else if(typeof t=="object"){const n=this._moves();for(let a=0,r=n.length;a<r;a++)if(t.from===L(n[a].from)&&t.to===L(n[a].to)&&(!("promotion"in n[a])||t.promotion===n[a].promotion)){s=n[a];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&w.NULL_MOVE)throw new Error("Null move not allowed when in check");const i=new ne(this,s);return this._makeMove(s),this._incPositionCount(),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){var i,n,a,r;const e=this._turn,s=X(e);if(this._push(t),t.flags&w.NULL_MOVE){e===O&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=P;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&w.EP_CAPTURE&&(this._turn===O?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===I){if(this._kings[e]=t.to,t.flags&w.KSIDE_CASTLE){const l=t.to-1,f=t.to+1;this._movePiece(f,l)}else if(t.flags&w.QSIDE_CASTLE){const l=t.to+1,f=t.to-2;this._movePiece(f,l)}this._castling[e]=0}if(this._castling[e]){for(let l=0,f=H[e].length;l<f;l++)if(t.from===H[e][l].square&&this._castling[e]&H[e][l].flag){this._castling[e]^=H[e][l].flag;break}}if(this._castling[s]){for(let l=0,f=H[s].length;l<f;l++)if(t.to===H[s][l].square&&this._castling[s]&H[s][l].flag){this._castling[s]^=H[s][l].flag;break}}if(this._hash^=this._castlingKey(),t.flags&w.BIG_PAWN){let l;e===O?l=t.to-16:l=t.to+16,!(t.to-1&136)&&((i=this._board[t.to-1])==null?void 0:i.type)===T&&((n=this._board[t.to-1])==null?void 0:n.color)===s||!(t.to+1&136)&&((a=this._board[t.to+1])==null?void 0:a.type)===T&&((r=this._board[t.to+1])==null?void 0:r.color)===s?(this._epSquare=l,this._hash^=this._epKey()):this._epSquare=P}else this._epSquare=P;t.piece===T?this._halfMoves=0:t.flags&(w.CAPTURE|w.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===O&&this._moveNumber++,this._turn=s,this._hash^=ve}undo(){const t=this._hash,e=this._undoMove();if(e){const s=new ne(this,e);return this._decPositionCount(t),s}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=ve;const s=this._turn,i=X(s);if(e.flags&w.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&w.EP_CAPTURE){let n;s===O?n=e.to-16:n=e.to+16,this._set(n,{type:T,color:i})}else this._set(e.to,{type:e.captured,color:i});if(e.flags&(w.KSIDE_CASTLE|w.QSIDE_CASTLE)){let n,a;e.flags&w.KSIDE_CASTLE?(n=e.to+1,a=e.to-1):(n=e.to-2,a=e.to+1),this._movePiece(a,n)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){const s=[];let i=!1;for(const p in this._header)this._header[p]&&s.push(`[${p} "${this._header[p]}"]`+t),i=!0;i&&this._history.length&&s.push(t);const n=p=>{const k=this._comments[this.fen()];if(typeof k<"u"){const v=p.length>0?" ":"";p=`${p}${v}{${k}}`}return p},a=[];for(;this._history.length>0;)a.push(this._undoMove());const r=[];let l="";for(a.length===0&&r.push(n(""));a.length>0;){l=n(l);const p=a.pop();if(!p)break;if(!this._history.length&&p.color==="b"){const k=`${this._moveNumber}. ...`;l=l?`${l} ${k}`:k}else p.color==="w"&&(l.length&&r.push(l),l=this._moveNumber+".");l=l+" "+this._moveToSan(p,this._moves({legal:!0})),this._makeMove(p)}if(l.length&&r.push(n(l)),r.push(this._header.Result||"*"),e===0)return s.join("")+r.join(" ");const f=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},g=function(p,k){for(const v of k.split(" "))if(v){if(p+v.length>e){for(;f();)p--;s.push(t),p=0}s.push(v),p+=v.length,s.push(" "),p++}return f()&&p--,p};let _=0;for(let p=0;p<r.length;p++){if(_+r[p].length>e&&r[p].includes("{")){_=g(_,r[p]);continue}_+r[p].length>e&&p!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),_=0):p!==0&&(s.push(" "),_++),s.push(r[p]),_+=r[p].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??Se[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=Se[t]||null,!0):!1}getHeaders(){const t={};for(const[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));const i=ms(t);this.reset();const n=i.headers;let a="";for(const f in n)f.toLowerCase()==="fen"&&(a=n[f]),this.header(f,n[f]);if(!e)a&&this.load(a,{preserveHeaders:!0});else if(n.SetUp==="1"){if(!("FEN"in n))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(n.FEN,{preserveHeaders:!0})}let r=i.root;for(;r;){if(r.move){const f=this._moveFromSan(r.move,e);if(f==null)throw new Error(`Invalid move in PGN: ${r.move}`);this._makeMove(f),this._incPositionCount()}r.comment!==void 0&&(this._comments[this.fen()]=r.comment),r=r.variations[0]}const l=i.result;l&&Object.keys(this._header).length&&this._header.Result!==l&&this.setHeader("Result",l)}_moveToSan(t,e){let s="";if(t.flags&w.KSIDE_CASTLE)s="O-O";else if(t.flags&w.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&w.NULL_MOVE)return Ce;if(t.piece!==T){const i=Ps(t,e);s+=t.piece.toUpperCase()+i}t.flags&(w.CAPTURE|w.EP_CAPTURE)&&(t.piece===T&&(s+=L(t.from)[0]),s+="x"),s+=L(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=Ee(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==Ce)return{color:this._turn,from:0,to:0,piece:"k",flags:w.NULL_MOVE};let i=tt(s),n=this._moves({legal:!0,piece:i});for(let p=0,k=n.length;p<k;p++)if(s===Ee(this._moveToSan(n[p],n)))return n[p];if(e)return null;let a,r,l,f,g,_=!1;if(r=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),r?(a=r[1],l=r[2],f=r[3],g=r[4],l.length==1&&(_=!0)):(r=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),r&&(a=r[1],l=r[2],f=r[3],g=r[4],l.length==1&&(_=!0))),i=tt(s),n=this._moves({legal:!0,piece:a||i}),!f)return null;for(let p=0,k=n.length;p<k;p++)if(l){if((!a||a.toLowerCase()==n[p].piece)&&E[l]==n[p].from&&E[f]==n[p].to&&(!g||g.toLowerCase()==n[p].promotion))return n[p];if(_){const v=L(n[p].from);if((!a||a.toLowerCase()==n[p].piece)&&E[f]==n[p].to&&(l==v[0]||l==v[1])&&(!g||g.toLowerCase()==n[p].promotion))return n[p]}}else if(s===Ee(this._moveToSan(n[p],n)).replace("x",""))return n[p];return null}ascii(){let t=`   +------------------------+
`;for(let e=E.a8;e<=E.h1;e++){if(Z(e)===0&&(t+=" "+"87654321"[W(e)]+" |"),this._board[e]){const s=this._board[e].type,n=this._board[e].color===$?s.toUpperCase():s.toLowerCase();t+=" "+n+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const e=this._moves({legal:!1});let s=0;const i=this._turn;for(let n=0,a=e.length;n<a;n++)this._makeMove(e[n]),this._isKingAttacked(i)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let e=[];for(let s=E.a8;s<=E.h1;s++)this._board[s]==null?e.push(null):e.push({square:L(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in E){const e=E[t];return(W(e)+Z(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){const i=e.pop();if(!i)break;t?s.push(new ne(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){const t=[],e={},s=i=>{i in this._comments&&(e[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){const i=t.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(const i of[I,K])e[i]!==void 0&&(e[i]?this._castling[t]|=ae[i]:this._castling[t]&=~ae[i]);this._updateCastlingRights();const s=this.getCastlingRights(t);return(e[I]===void 0||e[I]===s[I])&&(e[K]===void 0||e[K]===s[K])}getCastlingRights(t){return{[I]:(this._castling[t]&ae[I])!==0,[K]:(this._castling[t]&ae[K])!==0}}moveNumber(){return this._moveNumber}}const ot={classic:{light:"#d9d7c3",dark:"#658047"},modern:{light:"#f0f0f0",dark:"#505050"},forest:{light:"#e6e6c8",dark:"#326432"},lichess:{light:"#f0d9b5",dark:"#b58863"},ocean:{light:"#add8e6",dark:"#006994"},volcanic:{light:"#ff6666",dark:"#323232"},desert:{light:"#edc9af",dark:"#bd9a7a"},space:{light:"#dcdcdc",dark:"#191970"},sunset:{light:"#ffcc99",dark:"#993366"},neon:{light:"#6414fe",dark:"#fe14ac"},coffee:{light:"#d2b48c",dark:"#654321"},ice:{light:"#c8e6ff",dark:"#325082"},midnight:{light:"#646496",dark:"#141428"},royal:{light:"#ffdfba",dark:"#4b0082"},pastel:{light:"#ffdab9",dark:"#ba55d3"},steampunk:{light:"#bdb76b",dark:"#581845"}},re=Object.keys(ot),st=[1,2,3,4,5,6,7,8,9,10];function it(h){const t=Math.round((h-1)*2.2222222222222223),e=Math.min(h+2,15);return{skillLevel:t,depth:e}}const F={playerColor:"w",difficulty:5,theme:"classic",volume:.5,soundEnabled:!0,analysisDepth:18},nt=300,$s=300,Bs=16,Os=22;function Ds(h){if(!h)return null;const{cp:t,mate:e}=h;return e!=null?e>0?1e4-Math.abs(e)*100:-1e4+Math.abs(e)*100:t??null}class qs{constructor(){this.chess=new rt,this.playerColor=F.playerColor,this.difficulty=F.difficulty,this.analysisDepth=F.analysisDepth,this.phase="setup",this.winner=null,this.settingsOpen=!1,this.showingPromotion=!1,this.promotionSquare=null,this.promotionFrom=null,this.showingHint=!1,this.bestMove=null,this.analyzing=!1,this.evaluation=null,this.analysisInfo=null,this.draggingDepthSlider=!1,this.targetEvalCp=0,this.currentEvalCp=0,this.targetIsMate=!1,this.targetMateIn=null,this.currentIsMate=!1,this.currentMateIn=null,this.evalAnimStart=0,this.evalAnimating=!1,this.analysisResults=null,this.lastPlayerColor=this.playerColor,this.lastDifficulty=this.difficulty}get fen(){return this.chess.fen()}get turn(){return this.chess.turn()}get isPlayerTurn(){return this.turn===this.playerColor}get board(){return this.chess.board()}legalMoves(){return this.chess.moves({verbose:!0})}legalMovesFrom(t){return this.chess.moves({square:t,verbose:!0})}makeMove(t){return this.chess.move(t)}undoMove(){return this.chess.undo()}isCapture(t){return t.captured!==void 0}isCheck(){return this.chess.inCheck()}checkGameOver(){return this.chess.isGameOver()?(this.phase="over",this.chess.isCheckmate()?this.winner=this.turn==="w"?"Black":"White":this.winner=null,!0):!1}startGame(){this.phase="playing",this.lastPlayerColor=this.playerColor,this.lastDifficulty=this.difficulty}newGame(){this.chess.reset(),this.playerColor=F.playerColor,this.difficulty=F.difficulty,this.phase="setup",this.winner=null,this.showingPromotion=!1,this.promotionSquare=null,this.promotionFrom=null,this.showingHint=!1,this.bestMove=null,this.analyzing=!1,this.evaluation=null,this.analysisInfo=null,this.analysisResults=null,this.targetEvalCp=0,this.currentEvalCp=0,this.evalAnimating=!1,this.targetIsMate=!1,this.targetMateIn=null,this.currentIsMate=!1,this.currentMateIn=null}resetGame(){this.chess.reset(),this.phase="playing",this.winner=null,this.showingPromotion=!1,this.showingHint=!1,this.bestMove=null,this.analyzing=!1,this.evaluation=null,this.analysisInfo=null,this.analysisResults=null,this.targetEvalCp=0,this.currentEvalCp=0,this.evalAnimating=!1,this.targetIsMate=!1,this.targetMateIn=null,this.currentIsMate=!1,this.currentMateIn=null}serialize(t){return{fen:this.fen,playerColor:this.playerColor,difficulty:this.difficulty,analysisResults:this.analysisResults,moveHistory:t?t.serialize():null}}deserialize(t){return this.chess.load(t.fen),this.playerColor=t.playerColor,this.difficulty=t.difficulty,this.phase="playing",this.winner=null,this.analysisResults=t.analysisResults||null,this.checkGameOver(),t.moveHistory||null}}class Rs{constructor(){this.moves=[],this.currentIndex=-1}addMove(t,e){this.moves.length===0&&this.moves.push({san:null,fen:null}),this.moves.push({san:t,fen:e}),this.currentIndex=-1}setInitialFen(t){this.moves.length===0?this.moves.push({san:null,fen:t}):this.moves[0].fen=t}removeLast(){this.moves.length>1&&(this.moves.pop(),this.currentIndex=-1)}clear(){this.moves=[],this.currentIndex=-1}getMoves(){return this.moves.slice(1)}get length(){return Math.max(0,this.moves.length-1)}canGoBack(){return this.moves.length>1&&this.currentIndex!==0}canGoForward(){return this.currentIndex!==-1&&this.currentIndex<this.moves.length-1}goBack(){return this.canGoBack()?(this.currentIndex===-1&&(this.currentIndex=this.moves.length-1),this.currentIndex--,this.moves[this.currentIndex].fen):null}goForward(){return this.canGoForward()?(this.currentIndex++,this.currentIndex===this.moves.length-1?(this.currentIndex=-1,null):this.moves[this.currentIndex].fen):null}goToStart(){return this.moves.length===0?null:(this.currentIndex=0,this.moves[0].fen)}goToEnd(){return this.currentIndex=-1,null}goToIndex(t){return t<0||t>=this.moves.length?null:t===this.moves.length-1?(this.currentIndex=-1,null):(this.currentIndex=t,this.moves[t].fen)}isAtCurrentPosition(){return this.currentIndex===-1}getCurrentViewIndex(){return this.currentIndex===-1?this.moves.length-1:this.currentIndex}serialize(){return this.moves.map(t=>({san:t.san,fen:t.fen}))}deserialize(t){this.moves=t.map(e=>({san:e.san,fen:e.fen})),this.currentIndex=-1}}const Gs=15e3;class Fs{constructor(){this.worker=null,this.ready=!1,this.analyzing=!1,this.onAnalysisUpdate=null,this.onBestMove=null,this._initResolve=null,this._initReject=null,this._readyCallback=null,this._analysisTimeoutId=null,this._moveTimeoutId=null}async init(){return new Promise((t,e)=>{this._initResolve=t,this._initReject=e;try{const i=`${location.origin}/claude-chess-web/stockfish/stockfish.js`;this.worker=new Worker(i),this.worker.onmessage=n=>{this._handleMessage(n.data)},this.worker.onerror=n=>{console.error("Engine worker error:",n),this._initReject&&(this._initReject(n),this._initReject=null),this.onBestMove&&(this.onBestMove(null),this.onBestMove=null)},this.worker.postMessage("uci")}catch(s){e(s)}})}_handleMessage(t){if(typeof t=="string"){if(t==="uciok"){this.ready=!0,this.worker.postMessage("isready");return}if(t==="readyok"){if(this._initResolve)this._initResolve(),this._initResolve=null;else if(this._readyCallback){const e=this._readyCallback;this._readyCallback=null,e()}return}if(t.startsWith("info")&&t.includes("score")){const e=this._parseInfo(t);e&&this.onAnalysisUpdate&&this.onAnalysisUpdate(e)}if(t.startsWith("bestmove")){const s=t.split(" ")[1];this.analyzing=!1,this.onBestMove&&(this.onBestMove(s),this.onBestMove=null)}}}_parseInfo(t){const e=t.split(" "),s={};for(let i=0;i<e.length;i++)e[i]==="depth"&&(s.depth=parseInt(e[i+1],10)),e[i]==="score"&&(e[i+1]==="cp"?(s.cp=parseInt(e[i+2],10),s.mate=null):e[i+1]==="mate"&&(s.mate=parseInt(e[i+2],10),s.cp=null)),e[i]==="pv"&&(s.pv=e.slice(i+1));return s.pv&&s.pv.length>0&&(s.bestMove=s.pv[0]),s.depth!==void 0?s:null}setDifficulty(t){if(!this.ready)return;const{skillLevel:e}=it(t);this.worker.postMessage(`setoption name Skill Level value ${e}`)}getMove(t,e){return new Promise(s=>{if(!this.ready){s(null);return}this.stopAnalysis();const{depth:i}=it(e);this._moveTimeoutId=setTimeout(()=>{this._moveTimeoutId=null,console.warn("Engine move timed out"),this.onBestMove=null,this.worker.postMessage("stop"),s(null)},Gs),this._readyCallback=()=>{this.onBestMove=n=>{this._moveTimeoutId&&(clearTimeout(this._moveTimeoutId),this._moveTimeoutId=null),s(n)},this.worker.postMessage(`position fen ${t}`),this.worker.postMessage(`go depth ${i}`)},this.worker.postMessage("isready")})}startAnalysis(t,e=18){this.ready&&(this.analyzing=!0,this.worker.postMessage("stop"),this._analysisTimeoutId&&clearTimeout(this._analysisTimeoutId),this._analysisTimeoutId=setTimeout(()=>{this._analysisTimeoutId=null,!(!this.ready||!this.worker)&&(this.worker.postMessage(`position fen ${t}`),this.worker.postMessage(`go depth ${e}`))},50))}analyzePosition(t,e){return new Promise(s=>{if(!this.ready){s(null);return}this.stopAnalysis();let i=null;const n=setTimeout(()=>{this.onAnalysisUpdate=null,this.onBestMove=null,this.worker.postMessage("stop"),s(i)},e+5e3);this._readyCallback=()=>{this.onAnalysisUpdate=a=>{i={cp:a.cp,mate:a.mate,depth:a.depth,bestMove:a.bestMove||a.pv&&a.pv[0]||null}},this.onBestMove=()=>{clearTimeout(n),this.onAnalysisUpdate=null,s(i)},this.worker.postMessage(`position fen ${t}`),this.worker.postMessage(`go movetime ${e}`)},this.worker.postMessage("isready")})}stopAnalysis(){this.ready&&(this.analyzing=!1,this._analysisTimeoutId&&(clearTimeout(this._analysisTimeoutId),this._analysisTimeoutId=null),this.worker.postMessage("stop"))}destroy(){this._analysisTimeoutId&&(clearTimeout(this._analysisTimeoutId),this._analysisTimeoutId=null),this._moveTimeoutId&&(clearTimeout(this._moveTimeoutId),this._moveTimeoutId=null),this.worker&&(this.worker.postMessage("quit"),this.worker.terminate(),this.worker=null,this.ready=!1)}}const oe=["a","b","c","d","e","f","g","h"],we=["1","2","3","4","5","6","7","8"];class Hs{constructor(t){this.container=t,this.flipped=!1,this.selectedSquare=null,this.legalMoves=[],this.lastMove=null,this.squares={},this.pieces={},this.hintArrow=null,this.onSquareClick=null,this.onPieceDragStart=null,this.onPieceDrop=null,this._dragging=!1,this._dragPiece=null,this._dragFrom=null,this._dragGhost=null,this._animating=!1,this._animationResolve=null,this._boundMouseMove=e=>this._onMouseMove(e),this._boundMouseUp=e=>this._onMouseUp(e),this._boundTouchMove=e=>this._onTouchMove(e),this._boundTouchEnd=e=>this._onTouchEnd(e),this._build()}_build(){this.boardEl=document.createElement("div"),this.boardEl.className="board",this.svgOverlay=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgOverlay.classList.add("board-svg-overlay"),this.svgOverlay.setAttribute("viewBox","0 0 800 800");const t=document.createElementNS("http://www.w3.org/2000/svg","defs"),e=document.createElementNS("http://www.w3.org/2000/svg","marker");e.setAttribute("id","arrowhead"),e.setAttribute("markerWidth","10"),e.setAttribute("markerHeight","7"),e.setAttribute("refX","10"),e.setAttribute("refY","3.5"),e.setAttribute("orient","auto");const s=document.createElementNS("http://www.w3.org/2000/svg","polygon");s.setAttribute("points","0 0, 10 3.5, 0 7"),s.setAttribute("fill","rgba(0, 220, 0, 0.85)"),e.appendChild(s),t.appendChild(e),this.svgOverlay.appendChild(t);for(let i=0;i<8;i++)for(let n=0;n<8;n++){const a=document.createElement("div"),r=oe[n],l=we[7-i],f=r+l,g=(i+n)%2===0;if(a.className=`square ${g?"light":"dark"}`,a.dataset.square=f,i===7){const _=document.createElement("span");_.className=`label file-label ${g?"on-light":"on-dark"}`,_.textContent=r,a.appendChild(_)}if(n===0){const _=document.createElement("span");_.className=`label rank-label ${g?"on-light":"on-dark"}`,_.textContent=l,a.appendChild(_)}a.addEventListener("mousedown",_=>this._onMouseDown(_,f)),this.boardEl.appendChild(a),this.squares[f]=a}this.boardEl.addEventListener("contextmenu",i=>i.preventDefault()),this.boardEl.appendChild(this.svgOverlay),this.container.appendChild(this.boardEl),document.addEventListener("mousemove",this._boundMouseMove),document.addEventListener("mouseup",this._boundMouseUp),this.boardEl.addEventListener("touchstart",i=>this._onTouchStart(i),{passive:!1}),document.addEventListener("touchmove",this._boundTouchMove,{passive:!1}),document.addEventListener("touchend",this._boundTouchEnd)}renderPosition(t,e){for(const s in this.pieces)this.pieces[s]&&(this.pieces[s].remove(),delete this.pieces[s]);this.flipped=e==="b",this.boardEl.classList.toggle("flipped",this.flipped);for(let s=0;s<8;s++)for(let i=0;i<8;i++){const n=t[s][i];if(n){const a=oe[i],r=we[7-s],l=a+r;this._placePiece(l,n.color,n.type)}}}_placePiece(t,e,s){const i=document.createElement("img"),n=`${e==="w"?"w":"b"}${s.toUpperCase()}`;i.src=`/claude-chess-web/pieces/${n}.svg`,i.className="piece",i.draggable=!1,i.alt=n,this.squares[t].appendChild(i),this.pieces[t]=i}updatePosition(t){const e={};for(let i=0;i<8;i++)for(let n=0;n<8;n++){const a=oe[n],r=we[7-i],l=a+r,f=t[i][n];e[l]=f?`${f.color}${f.type.toUpperCase()}`:null}const s={};for(const i in this.pieces)if(this.pieces[i]){const n=this.pieces[i].alt;s[i]=n}for(const i in s)s[i]!==e[i]&&(this.pieces[i].remove(),delete this.pieces[i]);for(const i in e)if(e[i]&&!this.pieces[i]){const n=e[i],a=n[0],r=n[1];this._placePiece(i,a,r)}}animateMove(t,e,s){return new Promise(i=>{this._animating=!0,this._animationResolve=i;const n=this.pieces[t];if(!n){this._animating=!1,i();return}const a=this.squares[t].getBoundingClientRect(),r=this.squares[e].getBoundingClientRect(),l=r.left-a.left,f=r.top-a.top;this.pieces[e]&&(this.pieces[e].remove(),delete this.pieces[e]),n.style.transition="none",n.style.transform=`translate(${l}px, ${f}px)`,n.style.zIndex="10",n.style.transform="translate(0, 0)",n.offsetHeight,n.style.transition=`transform ${nt}ms ease-out`,n.style.transform=`translate(${l}px, ${f}px)`,setTimeout(()=>{n.style.transition="none",n.style.transform="",n.style.zIndex="",this.pieces[t]&&(this.pieces[t].remove(),delete this.pieces[t]),this.updatePosition(s),this._animating=!1,i()},nt)})}setSelected(t){this.selectedSquare&&this.squares[this.selectedSquare].classList.remove("selected"),this.clearLegalMoves(),this.selectedSquare=t,t&&this.squares[t].classList.add("selected")}showLegalMoves(t){this.clearLegalMoves(),this.legalMoves=t.map(e=>e.to);for(const e of t)this.squares[e.to].classList.add("legal-move"),e.captured&&this.squares[e.to].classList.add("legal-capture")}clearLegalMoves(){for(const t of this.legalMoves)this.squares[t]&&this.squares[t].classList.remove("legal-move","legal-capture");this.legalMoves=[]}setLastMove(t,e){var s,i,n,a;this.lastMove&&((s=this.squares[this.lastMove.from])==null||s.classList.remove("last-move"),(i=this.squares[this.lastMove.to])==null||i.classList.remove("last-move")),this.lastMove=t&&e?{from:t,to:e}:null,this.lastMove&&((n=this.squares[t])==null||n.classList.add("last-move"),(a=this.squares[e])==null||a.classList.add("last-move"))}setCheck(t){var e;for(const s in this.squares)this.squares[s].classList.remove("check");t&&((e=this.squares[t])==null||e.classList.add("check"))}showHintArrow(t,e){var a,r;if(this.clearHintArrow(),!t||!e)return;(a=this.squares[t])==null||a.classList.add("hint-from"),(r=this.squares[e])==null||r.classList.add("hint-to");const s=this._squareToSvgCoords(t),i=this._squareToSvgCoords(e),n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("x1",s.x),n.setAttribute("y1",s.y),n.setAttribute("x2",i.x),n.setAttribute("y2",i.y),n.setAttribute("stroke","rgba(0, 220, 0, 0.85)"),n.setAttribute("stroke-width","8"),n.setAttribute("marker-end","url(#arrowhead)"),n.classList.add("hint-arrow"),this.svgOverlay.appendChild(n),this.hintArrow=n}clearHintArrow(){this.hintArrow&&(this.hintArrow.remove(),this.hintArrow=null);for(const t in this.squares)this.squares[t].classList.remove("hint-from","hint-to")}_squareToSvgCoords(t){const e=oe.indexOf(t[0]),s=parseInt(t[1])-1;let i,n;return this.flipped?(i=(7-e)*100+50,n=s*100+50):(i=e*100+50,n=(7-s)*100+50),{x:i,y:n}}get isAnimating(){return this._animating}_onMouseDown(t,e){if(this._animating||t.button!==0)return;t.preventDefault();const s=this.pieces[e];if(s&&this.onPieceDragStart&&this.onPieceDragStart(e)){this._startDrag(t,e,s);return}this.onSquareClick&&this.onSquareClick(e)}_startDrag(t,e,s){this._dragging=!0,this._dragFrom=e,this._dragPiece=s,this._dragGhost=s.cloneNode(!0),this._dragGhost.className="piece drag-ghost",document.body.appendChild(this._dragGhost);const i=s.getBoundingClientRect();this._dragGhost.style.width=i.width+"px",this._dragGhost.style.height=i.height+"px",this._positionGhost(t.clientX,t.clientY,i.width),s.style.opacity="0.3",this.onSquareClick&&this.onSquareClick(e)}_positionGhost(t,e,s){if(!this._dragGhost)return;const i=s||parseInt(this._dragGhost.style.width);this._dragGhost.style.left=t-i/2+"px",this._dragGhost.style.top=e-i/2+"px"}_onMouseMove(t){!this._dragging||!this._dragGhost||this._positionGhost(t.clientX,t.clientY)}_onMouseUp(t){if(!this._dragging)return;const e=this._getSquareFromPoint(t.clientX,t.clientY);this._cleanupDrag(),e&&e!==this._dragFrom&&this.onSquareClick&&this.onSquareClick(e)}_cleanupDrag(){this._dragGhost&&(this._dragGhost.remove(),this._dragGhost=null),this._dragPiece&&(this._dragPiece.style.opacity=""),this._dragging=!1,this._dragFrom=null,this._dragPiece=null}_getSquareFromPoint(t,e){const s=document.elementFromPoint(t,e);if(!s)return null;const i=s.closest(".square");return i?i.dataset.square:null}_onTouchStart(t){if(this._animating)return;const e=t.touches[0],s=this._getSquareFromPoint(e.clientX,e.clientY);if(!s)return;t.preventDefault();const i=this.pieces[s];if(i&&this.onPieceDragStart&&this.onPieceDragStart(s)){this._dragging=!0,this._dragFrom=s,this._dragPiece=i,this._dragGhost=i.cloneNode(!0),this._dragGhost.className="piece drag-ghost",document.body.appendChild(this._dragGhost);const a=i.getBoundingClientRect();this._dragGhost.style.width=a.width+"px",this._dragGhost.style.height=a.height+"px",this._positionGhost(e.clientX,e.clientY,a.width),i.style.opacity="0.3"}this.onSquareClick&&this.onSquareClick(s)}_onTouchMove(t){if(!this._dragging)return;t.preventDefault();const e=t.touches[0];this._positionGhost(e.clientX,e.clientY)}_onTouchEnd(t){if(!this._dragging)return;const e=t.changedTouches[0],s=this._getSquareFromPoint(e.clientX,e.clientY);this._cleanupDrag(),s&&s!==this._dragFrom&&this.onSquareClick&&this.onSquareClick(s)}destroy(){document.removeEventListener("mousemove",this._boundMouseMove),document.removeEventListener("mouseup",this._boundMouseUp),document.removeEventListener("touchmove",this._boundTouchMove),document.removeEventListener("touchend",this._boundTouchEnd),this._cleanupDrag()}applyTheme(t){const e=ot[t];e&&(document.documentElement.style.setProperty("--light-square",e.light),document.documentElement.style.setProperty("--dark-square",e.dark))}}class Vs{constructor(t){this.container=t,this.playerColor="w",this._currentCp=0,this._targetCp=0,this._isMate=!1,this._mateIn=null,this._animStart=0,this._animating=!1,this._rafId=null,this._build()}_build(){this.el=document.createElement("div"),this.el.className="eval-bar",this.whiteSection=document.createElement("div"),this.whiteSection.className="eval-white",this.blackSection=document.createElement("div"),this.blackSection.className="eval-black",this.scoreLabel=document.createElement("div"),this.scoreLabel.className="eval-score",this.tickContainer=document.createElement("div"),this.tickContainer.className="eval-ticks",this.el.appendChild(this.blackSection),this.el.appendChild(this.whiteSection),this.el.appendChild(this.scoreLabel),this.el.appendChild(this.tickContainer),this.container.appendChild(this.el),this._renderTicks(),this._updateBar(0)}_renderTicks(){this.tickContainer.innerHTML="";for(let e=-10;e<=10;e+=2){if(e===0)continue;const s=document.createElement("div");s.className="eval-tick";const i=50-e*5;s.style.top=`${i}%`,this.tickContainer.appendChild(s)}const t=document.createElement("div");t.className="eval-center-line",this.tickContainer.appendChild(t)}setPlayerColor(t){this.playerColor=t,this.el.classList.toggle("flipped",t==="b")}update(t){if(!t){this._showCalculating();return}const{cp:e,mate:s}=t;if(s!=null){this._isMate=!0,this._mateIn=s;const i=s>0?1e4-Math.abs(s)*100:-1e4+Math.abs(s)*100;this._setTarget(i)}else e!=null&&(this._isMate=!1,this._mateIn=null,this._setTarget(e))}_setTarget(t){this._targetCp=t,this._animStart=performance.now(),this._animating=!0,this._rafId||this._animate()}_animate(){if(!this._animating){this._rafId=null;return}const t=performance.now()-this._animStart,e=Math.min(1,t/$s),s=1-Math.pow(1-e,2);this._currentCp=this._currentCp+(this._targetCp-this._currentCp)*s,e>=1&&(this._currentCp=this._targetCp,this._animating=!1),this._updateBar(this._currentCp),this._updateLabel(),this._rafId=requestAnimationFrame(()=>this._animate())}_updateBar(t){const s=50+Math.max(-1e3,Math.min(1e3,t))/1e3*50;this.whiteSection.style.height=`${s}%`,this.blackSection.style.height=`${100-s}%`}_updateLabel(){if(this._isMate&&this._mateIn!==null){const t=`M${Math.abs(this._mateIn)}`;this.scoreLabel.textContent=t,this._mateIn>0?this.scoreLabel.className="eval-score white-advantage":this.scoreLabel.className="eval-score black-advantage"}else{const t=Math.abs(this._currentCp/100);this.scoreLabel.textContent=t.toFixed(1),this._currentCp>=0?this.scoreLabel.className="eval-score white-advantage":this.scoreLabel.className="eval-score black-advantage"}}_showCalculating(){this.scoreLabel.textContent="...",this.scoreLabel.className="eval-score calculating"}reset(){this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._currentCp=0,this._targetCp=0,this._isMate=!1,this._mateIn=null,this._animating=!1,this._updateBar(0),this.scoreLabel.textContent="0.0",this.scoreLabel.className="eval-score white-advantage"}destroy(){this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._animating=!1}}class Ks{constructor(t){this.container=t,this.onMoveClick=null,this._build()}_build(){this.el=document.createElement("div"),this.el.className="move-list",this.titleEl=document.createElement("h3"),this.titleEl.className="move-list-title",this.titleEl.textContent="Move History",this.listEl=document.createElement("div"),this.listEl.className="move-list-content",this.el.appendChild(this.titleEl),this.el.appendChild(this.listEl),this.container.appendChild(this.el)}render(t){this.listEl.innerHTML="";const e=t.getMoves();if(e.length===0){const i=document.createElement("div");i.className="move-list-empty",i.textContent="No moves yet",this.listEl.appendChild(i);return}const s=t.getCurrentViewIndex();for(let i=0;i<e.length;i+=2){const n=document.createElement("div");n.className="move-row";const a=document.createElement("span");a.className="move-number",a.textContent=`${Math.floor(i/2)+1}.`,n.appendChild(a);const r=document.createElement("span");r.className="move-san",r.textContent=e[i].san;const l=i+1;if(l===s&&r.classList.add("active"),r.addEventListener("click",()=>{this.onMoveClick&&this.onMoveClick(l)}),n.appendChild(r),i+1<e.length){const f=document.createElement("span");f.className="move-san",f.textContent=e[i+1].san;const g=i+2;g===s&&f.classList.add("active"),f.addEventListener("click",()=>{this.onMoveClick&&this.onMoveClick(g)}),n.appendChild(f)}this.listEl.appendChild(n)}this.listEl.scrollTop=this.listEl.scrollHeight}clear(){this.listEl.innerHTML="";const t=document.createElement("div");t.className="move-list-empty",t.textContent="No moves yet",this.listEl.appendChild(t)}}class Us{constructor(t){this.container=t,this.visible=!1,this.onMoveClick=null,this.onCancel=null,this._points=[],this._evaluations=null,this._highlightIndex=-1,this._build()}_build(){this.overlay=document.createElement("div"),this.overlay.className="analysis-graph-overlay",this.overlay.style.display="none",this.progressEl=document.createElement("div"),this.progressEl.className="analysis-progress",this.progressEl.style.display="none",this.progressText=document.createElement("div"),this.progressText.className="analysis-progress-text",this.progressText.textContent="Analyzing...";const t=document.createElement("div");t.className="analysis-progress-bar-outer",this.progressBarInner=document.createElement("div"),this.progressBarInner.className="analysis-progress-bar-inner",t.appendChild(this.progressBarInner),this.cancelBtn=document.createElement("button"),this.cancelBtn.className="analysis-graph-close",this.cancelBtn.textContent="Cancel",this.cancelBtn.addEventListener("click",()=>{this.onCancel&&this.onCancel()}),this.progressEl.appendChild(this.progressText),this.progressEl.appendChild(t),this.progressEl.appendChild(this.cancelBtn),this.graphEl=document.createElement("div"),this.graphEl.style.display="none",this.graphEl.style.cssText="display:none;flex-direction:column;align-items:center;gap:12px;",this.canvas=document.createElement("canvas"),this.canvas.className="analysis-graph-canvas",this.canvas.width=700,this.canvas.height=500,this.canvas.addEventListener("click",e=>this._handleCanvasClick(e)),this.canvas.addEventListener("mousemove",e=>this._handleCanvasMouseMove(e)),this.closeBtn=document.createElement("button"),this.closeBtn.className="analysis-graph-close",this.closeBtn.textContent="Close",this.closeBtn.addEventListener("click",()=>this.hide()),this.graphEl.appendChild(this.canvas),this.graphEl.appendChild(this.closeBtn),this.overlay.appendChild(this.progressEl),this.overlay.appendChild(this.graphEl),this.container.appendChild(this.overlay)}showProgress(){this.visible=!0,this.overlay.style.display="flex",this.progressEl.style.display="flex",this.graphEl.style.display="none",this.progressText.textContent="Analyzing...",this.progressBarInner.style.width="0%"}updateProgress(t,e){this.progressText.textContent=`Analyzing move ${t}/${e}...`,this.progressBarInner.style.width=`${t/e*100}%`}showGraph(t){!t||t.length<2||(this._evaluations=t,this._highlightIndex=-1,this.visible=!0,this.overlay.style.display="flex",this.progressEl.style.display="none",this.graphEl.style.display="flex",this._draw())}setHighlight(t){this._highlightIndex!==t&&(this._highlightIndex=t,this._evaluations&&this.visible&&this._draw())}hide(){this.visible=!1,this.overlay.style.display="none",this.progressEl.style.display="none",this.graphEl.style.display="none"}_draw(){const t=this._evaluations;if(!t)return;const e=this.canvas.getContext("2d"),s=this.canvas.width,i=this.canvas.height,n={top:40,right:30,bottom:40,left:50},a=s-n.left-n.right,r=i-n.top-n.bottom;e.fillStyle="#28283a",e.fillRect(0,0,s,i),e.strokeStyle="#64647a",e.lineWidth=2,e.strokeRect(n.left,n.top,a,r);const l=n.top+r/2,f=1e3;e.strokeStyle="#3c3c50",e.lineWidth=1;for(const p of[2,4,6,8])for(const k of[1,-1]){const v=l-k*p*r/2/10;v>n.top&&v<n.top+r&&(e.beginPath(),e.moveTo(n.left,v),e.lineTo(n.left+a,v),e.stroke())}e.strokeStyle="#666",e.lineWidth=1,e.beginPath(),e.moveTo(n.left,l),e.lineTo(n.left+a,l),e.stroke(),e.fillStyle="#fff",e.font="bold 18px Arial",e.textAlign="center",e.fillText("Game Analysis",s/2,n.top-12),e.fillStyle="#999",e.font="11px Arial",e.textAlign="right";for(let p=-10;p<=10;p+=2){const k=l-p*r/2/10;k>=n.top&&k<=n.top+r&&e.fillText((p>0?"+":"")+p,n.left-8,k+4)}const g=t.length,_=a/Math.max(g-1,1);this._points=[];for(let p=0;p<g;p++){const k=t[p];if(k==null)continue;const v=n.left+p*_,M=Math.max(-f,Math.min(f,k));let x=l-M*r/2/f;x=Math.max(n.top,Math.min(n.top+r,x)),this._points.push({x:v,y:x,idx:p})}if(!(this._points.length<2)){for(let p=0;p<this._points.length-1;p++){const k=this._points[p],v=this._points[p+1];(k.y<=l||v.y<=l)&&(e.fillStyle="rgba(255, 255, 255, 0.15)",e.beginPath(),e.moveTo(k.x,Math.min(k.y,l)),e.lineTo(v.x,Math.min(v.y,l)),e.lineTo(v.x,l),e.lineTo(k.x,l),e.closePath(),e.fill()),(k.y>=l||v.y>=l)&&(e.fillStyle="rgba(50, 50, 50, 0.15)",e.beginPath(),e.moveTo(k.x,l),e.lineTo(v.x,l),e.lineTo(v.x,Math.max(v.y,l)),e.lineTo(k.x,Math.max(k.y,l)),e.closePath(),e.fill())}e.strokeStyle="#00c864",e.lineWidth=2,e.beginPath(),e.moveTo(this._points[0].x,this._points[0].y);for(let p=1;p<this._points.length;p++)e.lineTo(this._points[p].x,this._points[p].y);e.stroke();for(const p of this._points)p.idx===this._highlightIndex?(e.fillStyle="#fff",e.beginPath(),e.arc(p.x,p.y,7,0,Math.PI*2),e.fill(),e.fillStyle="#ffb020",e.beginPath(),e.arc(p.x,p.y,5,0,Math.PI*2),e.fill()):(e.fillStyle="#00ff82",e.beginPath(),e.arc(p.x,p.y,3,0,Math.PI*2),e.fill());e.fillStyle="#999",e.font="12px Arial",e.textAlign="center",e.fillText(`Moves (1-${g})`,s/2,i-10)}}_getCanvasPoint(t){const e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height;return{x:(t.clientX-e.left)*s,y:(t.clientY-e.top)*i}}_findNearestPoint(t,e){let s=null,i=1/0;for(const n of this._points){const a=n.x-t,r=n.y-e,l=Math.sqrt(a*a+r*r);l<i&&(i=l,s=n)}return i<=20?s:null}_handleCanvasClick(t){const{x:e,y:s}=this._getCanvasPoint(t),i=this._findNearestPoint(e,s);i&&this.onMoveClick&&this.onMoveClick(i.idx)}_handleCanvasMouseMove(t){const{x:e,y:s}=this._getCanvasPoint(t),i=this._findNearestPoint(e,s);this.canvas.style.cursor=i?"pointer":"default"}}class zs{constructor(t){this.container=t,this._resolve=null,this._build()}_build(){this.overlay=document.createElement("div"),this.overlay.className="promotion-overlay",this.overlay.style.display="none",this.dialog=document.createElement("div"),this.dialog.className="promotion-dialog",this.overlay.appendChild(this.dialog),this.container.appendChild(this.overlay),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.hide(null)})}show(t,e){return new Promise(s=>{this._resolve=s,this.dialog.innerHTML="";const i=["q","r","b","n"];for(const n of i){const a=document.createElement("button");a.className="promotion-piece";const r=document.createElement("img"),l=`${t}${n.toUpperCase()}`;r.src=`/claude-chess-web/pieces/${l}.svg`,r.alt=l,a.appendChild(r),a.addEventListener("click",()=>this.hide(n)),this.dialog.appendChild(a)}this.overlay.style.display="flex"})}hide(t){this.overlay.style.display="none",this._resolve&&(this._resolve(t),this._resolve=null)}}class Ws{constructor(t){this.container=t,this.selectedColor=F.playerColor,this.selectedDifficulty=F.difficulty,this.onStart=null,this._build()}_build(){this.overlay=document.createElement("div"),this.overlay.className="setup-overlay",this.overlay.style.display="none",this.overlay.addEventListener("click",g=>{g.target===this.overlay&&this.hide()});const t=document.createElement("div");t.className="setup-panel";const e=document.createElement("h2");e.className="setup-title",e.textContent="New Game",t.appendChild(e);const s=document.createElement("div");s.className="setup-section";const i=document.createElement("h3");i.className="setup-label",i.textContent="Select Side",s.appendChild(i);const n=document.createElement("div");n.className="color-selection",this.whiteBtn=document.createElement("button"),this.whiteBtn.className="color-btn selected",this.whiteBtn.innerHTML=`
      <img src="/claude-chess-web/pieces/wK.svg" alt="White King" class="color-king">
      <span>White</span>
    `,this.whiteBtn.addEventListener("click",()=>this._selectColor("w")),this.blackBtn=document.createElement("button"),this.blackBtn.className="color-btn",this.blackBtn.innerHTML=`
      <img src="/claude-chess-web/pieces/bK.svg" alt="Black King" class="color-king">
      <span>Black</span>
    `,this.blackBtn.addEventListener("click",()=>this._selectColor("b")),n.appendChild(this.whiteBtn),n.appendChild(this.blackBtn),s.appendChild(n),t.appendChild(s);const a=document.createElement("div");a.className="setup-section";const r=document.createElement("h3");r.className="setup-label",r.textContent="Difficulty",a.appendChild(r);const l=document.createElement("div");l.className="difficulty-selection",this.diffBtns=[];for(const g of st){const _=document.createElement("button");_.className="diff-btn"+(g===this.selectedDifficulty?" selected":""),_.textContent=g,_.addEventListener("click",()=>this._selectDifficulty(g)),l.appendChild(_),this.diffBtns.push(_)}a.appendChild(l),t.appendChild(a);const f=document.createElement("button");f.className="start-btn",f.textContent="Start Game",f.addEventListener("click",()=>{this.onStart&&this.onStart({color:this.selectedColor,difficulty:this.selectedDifficulty})}),t.appendChild(f),this.overlay.appendChild(t),this.container.appendChild(this.overlay)}_selectColor(t){this.selectedColor=t,this.whiteBtn.classList.toggle("selected",t==="w"),this.blackBtn.classList.toggle("selected",t==="b")}_selectDifficulty(t){this.selectedDifficulty=t,this.diffBtns.forEach((e,s)=>{e.classList.toggle("selected",st[s]===t)})}show(t,e){t&&this._selectColor(t),e&&this._selectDifficulty(e),this.overlay.style.display="flex"}hide(){this.overlay.style.display="none"}}class js{constructor(t){this.container=t,this.onRestart=null,this.onNewGame=null,this.onAnalyze=null,this._selectedTime=3e3,this._build()}_build(){this.el=document.createElement("div"),this.el.className="game-over-overlay",this.el.style.display="none",this.inner=document.createElement("div"),this.inner.className="game-over-inner",this.resultText=document.createElement("h2"),this.resultText.className="game-over-result",this.btnRow=document.createElement("div"),this.btnRow.className="game-over-buttons";const t=document.createElement("button");t.className="go-btn",t.textContent="Rematch",t.addEventListener("click",()=>{this.hide(),this.onRestart&&this.onRestart()});const e=document.createElement("button");e.className="go-btn",e.textContent="New Game",e.addEventListener("click",()=>{this.hide(),this.onNewGame&&this.onNewGame()});const s=document.createElement("button");s.className="go-btn go-btn-secondary",s.textContent="Analyze Game",s.addEventListener("click",()=>{this.btnRow.style.display="none",this.timeSection.style.display="flex"}),this.btnRow.appendChild(t),this.btnRow.appendChild(e),this.btnRow.appendChild(s),this.timeSection=document.createElement("div"),this.timeSection.className="analysis-time-section",this.timeSection.style.display="none";const i=document.createElement("div");i.className="analysis-time-label",i.textContent="Seconds per move:";const n=document.createElement("div");n.className="analysis-time-options";const a=[{label:"1s",ms:1e3},{label:"3s",ms:3e3},{label:"5s",ms:5e3},{label:"10s",ms:1e4}];this._timeBtns=[];for(const{label:l,ms:f}of a){const g=document.createElement("button");g.className="analysis-time-btn",f===this._selectedTime&&g.classList.add("selected"),g.textContent=l,g.addEventListener("click",()=>{this._selectedTime=f;for(const _ of this._timeBtns)_.classList.remove("selected");g.classList.add("selected")}),n.appendChild(g),this._timeBtns.push(g)}const r=document.createElement("button");r.className="go-btn",r.textContent="Start Analysis",r.addEventListener("click",()=>{this.onAnalyze&&this.onAnalyze(this._selectedTime)}),this.timeSection.appendChild(i),this.timeSection.appendChild(n),this.timeSection.appendChild(r),this.inner.appendChild(this.resultText),this.inner.appendChild(this.btnRow),this.inner.appendChild(this.timeSection),this.el.appendChild(this.inner),this.container.appendChild(this.el)}show(t,e=!1){t?this.resultText.textContent=`${t} wins!`:this.resultText.textContent="Draw!",e?this._cachedResults=!0:this._cachedResults=!1,this.btnRow.style.display="flex",this.timeSection.style.display="none",this._selectedTime=3e3;for(const i of this._timeBtns)i.classList.toggle("selected",i.textContent==="3s");const s=this.btnRow.querySelector(".go-btn-secondary");if(s){const i=s.cloneNode(!0);s.parentNode.replaceChild(i,s),i.addEventListener("click",()=>{this._cachedResults?this.onAnalyze&&this.onAnalyze(null):(this.btnRow.style.display="none",this.timeSection.style.display="flex")})}this.el.style.display="flex"}hide(){this.el.style.display="none"}}class Qs{constructor(t){this.container=t,this.onThemeChange=null,this.onSoundToggle=null,this.onVolumeChange=null,this.onClose=null,this._currentThemeIndex=0,this._build()}_build(){this.overlay=document.createElement("div"),this.overlay.className="settings-overlay",this.overlay.style.display="none";const t=document.createElement("div");t.className="settings-panel";const e=document.createElement("h2");e.className="settings-title",e.textContent="Settings",t.appendChild(e),this.soundBtn=document.createElement("button"),this.soundBtn.className="settings-btn",this.soundBtn.addEventListener("click",()=>{this.onSoundToggle&&this.onSoundToggle()}),t.appendChild(this.soundBtn);const s=document.createElement("div");s.className="settings-row",this.volLabel=document.createElement("span"),this.volLabel.className="settings-vol-label";const i=document.createElement("button");i.className="settings-btn-small",i.textContent="-",i.addEventListener("click",()=>{this.onVolumeChange&&this.onVolumeChange(-.1)});const n=document.createElement("button");n.className="settings-btn-small",n.textContent="+",n.addEventListener("click",()=>{this.onVolumeChange&&this.onVolumeChange(.1)}),s.appendChild(i),s.appendChild(this.volLabel),s.appendChild(n),t.appendChild(s),this.themeBtn=document.createElement("button"),this.themeBtn.className="settings-btn",this.themeBtn.addEventListener("click",()=>{this._currentThemeIndex=(this._currentThemeIndex+1)%re.length,this.onThemeChange&&this.onThemeChange(re[this._currentThemeIndex]),this._updateThemeLabel()}),t.appendChild(this.themeBtn);const a=document.createElement("button");a.className="settings-btn settings-close-btn",a.textContent="Close",a.addEventListener("click",()=>{this.hide(),this.onClose&&this.onClose()}),t.appendChild(a),this.overlay.appendChild(t),this.container.appendChild(this.overlay),this.overlay.addEventListener("click",r=>{r.target===this.overlay&&(this.hide(),this.onClose&&this.onClose())})}show(t){this._currentThemeIndex=re.indexOf(t.theme)||0,this._updateSoundLabel(t.soundEnabled),this._updateVolumeLabel(t.volume),this._updateThemeLabel(),this.overlay.style.display="flex"}hide(){this.overlay.style.display="none"}_updateSoundLabel(t){this.soundBtn.textContent=`Sound: ${t?"ON":"OFF"}`,this.soundBtn.classList.toggle("active",t)}_updateVolumeLabel(t){this.volLabel.textContent=`Volume: ${Math.round(t*100)}%`}_updateThemeLabel(){const t=re[this._currentThemeIndex];this.themeBtn.textContent=`Theme: ${t.charAt(0).toUpperCase()+t.slice(1)}`}updateSettings(t){this._updateSoundLabel(t.soundEnabled),this._updateVolumeLabel(t.volume)}}class Ys{constructor(){this._ctx=null,this._buffers={},this.volume=.5,this.enabled=!0}load(){const t="/claude-chess-web/";this._ctx=new(window.AudioContext||window.webkitAudioContext),this._gainNode=this._ctx.createGain(),this._gainNode.gain.value=this.volume,this._gainNode.connect(this._ctx.destination);const e=["move","capture","check"];for(const i of e)fetch(`${t}sounds/${i}.wav`).then(n=>n.arrayBuffer()).then(n=>this._ctx.decodeAudioData(n)).then(n=>{this._buffers[i]=n}).catch(n=>console.warn(`Failed to load ${i} sound:`,n));const s=()=>{this._ctx.state==="suspended"&&this._ctx.resume(),document.removeEventListener("mousedown",s),document.removeEventListener("touchstart",s),document.removeEventListener("click",s)};document.addEventListener("mousedown",s),document.addEventListener("touchstart",s),document.addEventListener("click",s)}play(t){if(!this.enabled||!this._ctx)return;const e=this._buffers[t]||this._buffers.move;if(!e)return;this._ctx.state==="suspended"&&this._ctx.resume();const s=this._ctx.createBufferSource();s.buffer=e,s.connect(this._gainNode),s.start(0)}setVolume(t){this.volume=Math.max(0,Math.min(1,t)),this._gainNode&&(this._gainNode.gain.value=this.volume)}setEnabled(t){this.enabled=t}}class Xs{constructor(){this.state=new qs,this.history=new Rs,this.engine=new Fs,this.sound=new Ys,this.settings=this._loadSettings(),this.boardView=null,this.evalBar=null,this.moveList=null,this.analysisGraph=null,this.promotionDialog=null,this.setupScreen=null,this.gameOverOverlay=null,this.settingsDialog=null,this._leftPanelEl=null,this._depthSliderEl=null,this._depthValueEl=null,this._hintBtnEl=null,this._takeBackBtnEl=null,this._replayEl=null,this._cancelAnalysis=!1,this._boundKeyboard=t=>this._handleKeyboard(t),this._pendingTimeouts=[]}async init(){this.sound.volume=this.settings.volume,this.sound.enabled=this.settings.soundEnabled,this.sound.load();const t=document.getElementById("board-area"),e=document.getElementById("left-panel"),s=document.getElementById("right-panel"),i=document.getElementById("app-container"),n=document.getElementById("below-board");this.boardView=new Hs(t),this.boardView.applyTheme(this.settings.theme);const a=document.getElementById("board-column");this._opponentInfo=this._buildPlayerInfo("opponent"),a.insertBefore(this._opponentInfo,t);const r=document.createElement("div");r.id="board-row",a.insertBefore(r,t),r.appendChild(t),this.evalBar=new Vs(r),r.insertBefore(this.evalBar.el,t),this._playerInfo=this._buildPlayerInfo("player"),a.insertBefore(this._playerInfo,document.getElementById("below-board")),this._buildLeftPanel(e),this.moveList=new Ks(s),this.analysisGraph=new Us(t),this.promotionDialog=new zs(t),this.setupScreen=new Ws(i),this.gameOverOverlay=new js(t),this.settingsDialog=new Qs(i),this._buildBelowBoard(n),this._wireCallbacks();try{await this.engine.init(),console.log("Stockfish engine ready")}catch(l){console.warn("Engine failed to initialize:",l)}this.state.playerColor=this.settings.playerColor,this.state.difficulty=this.settings.difficulty,this._startGame()}_buildLeftPanel(t){this._leftPanelEl=document.createElement("div"),this._leftPanelEl.className="left-panel-buttons",this._leftPanelEl.style.display="none";const e=[{id:"restart",label:"Restart",action:()=>this._restart()},{id:"take-back",label:"Take Back",action:()=>this._takeBack()},{id:"new-game",label:"New Game",action:()=>this._newGame()},{id:"settings",label:"Settings",action:()=>this._openSettings()},{id:"save",label:"Save",action:()=>this._saveGame()},{id:"load",label:"Load",action:()=>this._loadGame()},{id:"hint",label:"Hint",action:()=>this._toggleHint()},{id:"resign",label:"Resign",action:()=>this._resign()}];for(const{id:i,label:n,action:a}of e){const r=document.createElement("button");r.className="panel-btn",r.id=`btn-${i}`,r.textContent=n,r.addEventListener("click",a),this._leftPanelEl.appendChild(r),i==="hint"&&(this._hintBtnEl=r,r.style.display="none"),i==="take-back"&&(this._takeBackBtnEl=r,r.style.display="none"),i==="resign"&&(this._resignBtnEl=r,r.style.display="none")}const s=document.createElement("div");s.className="depth-slider-container",this._depthValueEl=document.createElement("span"),this._depthValueEl.className="depth-label",this._depthValueEl.textContent=`Depth: ${this.state.analysisDepth}`,this._depthSliderEl=document.createElement("input"),this._depthSliderEl.type="range",this._depthSliderEl.min=Bs,this._depthSliderEl.max=Os,this._depthSliderEl.value=this.state.analysisDepth,this._depthSliderEl.className="depth-slider",this._depthSliderEl.addEventListener("input",i=>{const n=parseInt(i.target.value);this.state.analysisDepth=n,this._depthValueEl.textContent=`Depth: ${n}`,this.state.analyzing&&this.state.phase==="playing"&&(this.engine.stopAnalysis(),this._setTimeout(()=>{this.engine.startAnalysis(this.state.fen,n)},100))}),s.appendChild(this._depthValueEl),s.appendChild(this._depthSliderEl),this._leftPanelEl.appendChild(s),t.appendChild(this._leftPanelEl)}_buildBelowBoard(t){this._replayEl=document.createElement("div"),this._replayEl.className="replay-controls",this._replayEl.style.display="none";const e=document.createElement("button");e.className="replay-btn",e.innerHTML="&#9664;",e.addEventListener("click",()=>this._navigateHistory("back"));const s=document.createElement("button");s.className="replay-btn",s.innerHTML="&#9654;",s.addEventListener("click",()=>this._navigateHistory("forward")),this._replayEl.appendChild(e),this._replayEl.appendChild(s),t.appendChild(this._replayEl)}_wireCallbacks(){this.boardView.onSquareClick=t=>this._handleSquareClick(t),this.boardView.onPieceDragStart=t=>this._handleDragStart(t),this.moveList.onMoveClick=t=>this._goToMoveIndex(t),this.setupScreen.onStart=({color:t,difficulty:e})=>{this.state.playerColor=t,this.state.difficulty=e,this.settings.playerColor=t,this.settings.difficulty=e,this._saveSettings(),this._startGame()},this.gameOverOverlay.onRestart=()=>this._restart(),this.gameOverOverlay.onNewGame=()=>this._newGame(),this.gameOverOverlay.onAnalyze=t=>this._runPostGameAnalysis(t),this.analysisGraph.onMoveClick=t=>{this._goToMoveIndex(t),this.analysisGraph.setHighlight(t)},this.analysisGraph.onCancel=()=>{this._cancelAnalysis=!0},this.settingsDialog.onThemeChange=t=>{this.settings.theme=t,this.boardView.applyTheme(t),this._saveSettings()},this.settingsDialog.onSoundToggle=()=>{this.settings.soundEnabled=!this.settings.soundEnabled,this.sound.setEnabled(this.settings.soundEnabled),this._saveSettings(),this.settingsDialog.updateSettings(this.settings)},this.settingsDialog.onVolumeChange=t=>{this.settings.volume=Math.max(0,Math.min(1,this.settings.volume+t)),this.sound.setVolume(this.settings.volume),this._saveSettings(),this.settingsDialog.updateSettings(this.settings)},this.engine.onAnalysisUpdate=t=>this._handleAnalysisUpdate(t),document.addEventListener("keydown",this._boundKeyboard)}_showNewGameDialog(){this.setupScreen.show(this.state.playerColor,this.state.difficulty)}_startGame(){this.setupScreen.hide(),this.gameOverOverlay.hide(),this.analysisGraph.hide(),this.state.resetGame(),this.state.startGame(),this.history.clear(),this.history.setInitialFen(this.state.fen),this.boardView.renderPosition(this.state.board,this.state.playerColor),this.boardView.setLastMove(null,null),this.boardView.setCheck(null),this.boardView.clearHintArrow(),this._leftPanelEl.style.display="flex",this._hintBtnEl.style.display="block",this._takeBackBtnEl.style.display="block",this._takeBackBtnEl.disabled=!0,this._resignBtnEl.style.display="block",this._replayEl.style.display="none",this.evalBar.reset(),this.evalBar.setPlayerColor(this.state.playerColor),this.moveList.clear(),this.engine.setDifficulty(this.state.difficulty),this._updatePlayerInfos(),this._startAnalysis(),this.state.playerColor==="b"&&this._setTimeout(()=>this._makeAIMove(),300)}_restart(){this._cancelAnalysis=!0,this._clearPendingTimeouts(),this.gameOverOverlay.hide(),this.analysisGraph.hide(),this.state.resetGame(),this.state.playerColor=this.state.lastPlayerColor,this.state.difficulty=this.state.lastDifficulty,this.history.clear(),this.history.setInitialFen(this.state.fen),this.boardView.renderPosition(this.state.board,this.state.playerColor),this.boardView.setSelected(null),this.boardView.setLastMove(null,null),this.boardView.setCheck(null),this.boardView.clearHintArrow(),this.evalBar.reset(),this.evalBar.setPlayerColor(this.state.playerColor),this.moveList.clear(),this._hintBtnEl.style.display="block",this._hintBtnEl.textContent="Hint",this._takeBackBtnEl.style.display="block",this._resignBtnEl.style.display="block",this._takeBackBtnEl.disabled=!0,this._replayEl.style.display="none",this.engine.setDifficulty(this.state.difficulty),this._startAnalysis(),this.state.playerColor==="b"&&this._setTimeout(()=>this._makeAIMove(),300)}_newGame(){this._cancelAnalysis=!0,this._clearPendingTimeouts(),this.engine.stopAnalysis(),this._showNewGameDialog()}_handleSquareClick(t){if(this.state.phase!=="playing"||!this.history.isAtCurrentPosition()||this.boardView.isAnimating||!this.state.isPlayerTurn)return;const e=this.boardView.selectedSquare;if(e)if(t===e)this.boardView.setSelected(null);else{const s=this._getPieceAt(t);if(s&&s.color===this.state.playerColor){this.boardView.setSelected(t);const i=this.state.legalMovesFrom(t);this.boardView.showLegalMoves(i)}else this._tryMove(e,t)}else{const s=this._getPieceAt(t);if(s&&s.color===this.state.playerColor){this.boardView.setSelected(t);const i=this.state.legalMovesFrom(t);this.boardView.showLegalMoves(i)}}}_handleDragStart(t){if(this.state.phase!=="playing"||!this.history.isAtCurrentPosition()||!this.state.isPlayerTurn)return!1;const e=this._getPieceAt(t);return e&&e.color===this.state.playerColor}async _tryMove(t,e){const s=this._getPieceAt(t);if(s&&s.type==="p"){const i=this.state.playerColor==="w"?"8":"1";if(e[1]===i&&this.state.chess.moves({square:t,verbose:!0}).find(a=>a.to===e&&a.promotion)){const a=await this.promotionDialog.show(this.state.playerColor,e);a&&await this._executeMove({from:t,to:e,promotion:a}),this.boardView.setSelected(null);return}}await this._executeMove({from:t,to:e})}async _executeMove(t){this.boardView.setSelected(null),this.boardView.clearLegalMoves();const e=this.state.makeMove(t);if(e){if(this.state.isCheck()?this.sound.play("check"):e.captured?this.sound.play("capture"):this.sound.play("move"),this.history.addMove(e.san,this.state.fen),this.boardView.updatePosition(this.state.board),this.boardView.setLastMove(e.from,e.to),this._updateCheckHighlight(),this.moveList.render(this.history),this._takeBackBtnEl.disabled=!1,this.state.showingHint=!1,this.state.bestMove=null,this.boardView.clearHintArrow(),this._hintBtnEl.textContent="Hint",this.state.checkGameOver()){this._handleGameOver();return}this.state.isPlayerTurn?this._startAnalysis():(this.engine.stopAnalysis(),this._setTimeout(()=>this._makeAIMove(),400))}}async _makeAIMove(){if(this.state.phase!=="playing"||this.state.isPlayerTurn||this.boardView.isAnimating)return;this.engine.stopAnalysis();const t=await this.engine.getMove(this.state.fen,this.state.difficulty);if(!t||t==="(none)"){console.warn("Engine failed to produce a move, retrying..."),this._setTimeout(()=>this._makeAIMove(),500);return}const e=t.substring(0,2),s=t.substring(2,4),i=t.length>4?t[4]:void 0,n={from:e,to:s};i&&(n.promotion=i);const a=this.state.makeMove(n);if(!a){console.warn("Engine produced illegal move:",t,"retrying..."),this._setTimeout(()=>this._makeAIMove(),500);return}if(this.state.isCheck()?this.sound.play("check"):a.captured?this.sound.play("capture"):this.sound.play("move"),this.history.addMove(a.san,this.state.fen),await this.boardView.animateMove(e,s,this.state.board),this.boardView.setLastMove(e,s),this._updateCheckHighlight(),this.moveList.render(this.history),this.state.checkGameOver()){this._handleGameOver();return}this._startAnalysis()}_handleGameOver(){this.engine.stopAnalysis(),this._hintBtnEl.style.display="none",this._takeBackBtnEl.style.display="none",this._resignBtnEl.style.display="none",this._replayEl.style.display="flex",this.gameOverOverlay.show(this.state.winner,!!this.state.analysisResults)}_resign(){this.state.phase==="playing"&&(this._clearPendingTimeouts(),this.state.phase="over",this.state.winner=this.state.playerColor==="w"?"Black":"White",this._handleGameOver())}async _runPostGameAnalysis(t){if(this.state.analysisResults){this.gameOverOverlay.hide(),this.analysisGraph.showGraph(this.state.analysisResults.evaluations),this.analysisGraph.setHighlight(this.history.getCurrentViewIndex());return}this.gameOverOverlay.hide(),this.engine.stopAnalysis(),this._cancelAnalysis=!1,this.analysisGraph.showProgress();const e=this.history.moves,s=e.length,i=[];for(let n=0;n<s;n++){if(this._cancelAnalysis){this.analysisGraph.hide(),this.gameOverOverlay.show(this.state.winner,!1);return}this.analysisGraph.updateProgress(n+1,s);const a=e[n].fen,r=await this.engine.analyzePosition(a,t);if(this._cancelAnalysis){this.analysisGraph.hide(),this.gameOverOverlay.show(this.state.winner,!1);return}if(r){let l=Ds(r);l!==null&&a.split(" ")[1]==="b"&&(l=-l),i.push(l)}else i.push(null)}this.state.analysisResults={evaluations:i,movetime:t},this.analysisGraph.showGraph(i),this.analysisGraph.setHighlight(this.history.getCurrentViewIndex())}_takeBack(){if(this.state.phase!=="playing"||this.history.length===0||!this.history.isAtCurrentPosition())return;this._clearPendingTimeouts(),this.engine.stopAnalysis();const t=this.state.isPlayerTurn?2:1;for(let e=0;e<t&&this.history.length!==0;e++)this.state.undoMove(),this.history.removeLast();this.boardView.updatePosition(this.state.board),this.boardView.setLastMove(null,null),this._updateCheckHighlight(),this.state.showingHint=!1,this.state.bestMove=null,this.boardView.clearHintArrow(),this._hintBtnEl.textContent="Hint",this.moveList.render(this.history),this._takeBackBtnEl.disabled=this.history.length===0,this._startAnalysis()}_startAnalysis(){this.state.phase==="playing"&&(this.state.analyzing=!0,this.state.evaluation=null,this.state.bestMove=null,this.engine.onAnalysisUpdate=t=>this._handleAnalysisUpdate(t),this.engine.startAnalysis(this.state.fen,this.state.analysisDepth))}_handleAnalysisUpdate(t){this.state.phase!=="playing"&&this.state.phase!=="over"||(this.state.evaluation={cp:t.cp,mate:t.mate,depth:t.depth},t.bestMove&&(this.state.bestMove=t.bestMove,this.state.showingHint&&this._showHintArrow()),this.evalBar.update(this.state.evaluation))}_toggleHint(){this.state.showingHint=!this.state.showingHint,this.state.showingHint?(this._hintBtnEl.textContent="Hide Hint",this._showHintArrow()):(this._hintBtnEl.textContent="Hint",this.boardView.clearHintArrow())}_showHintArrow(){if(!this.state.bestMove)return;const t=this.state.bestMove.substring(0,2),e=this.state.bestMove.substring(2,4);this.boardView.showHintArrow(t,e)}_navigateHistory(t){let e=null;t==="back"?e=this.history.goBack():e=this.history.goForward(),e!==null?this._showPositionFromFen(e):t==="forward"&&this.history.isAtCurrentPosition()&&this.boardView.updatePosition(this.state.board),this.moveList.render(this.history),this.analysisGraph.visible&&this.analysisGraph.setHighlight(this.history.getCurrentViewIndex())}_goToMoveIndex(t){const e=this.history.goToIndex(t);e!==null?this._showPositionFromFen(e):this.history.isAtCurrentPosition()&&this.boardView.updatePosition(this.state.board),this.moveList.render(this.history),this.analysisGraph.visible&&this.analysisGraph.setHighlight(t)}_showPositionFromFen(t){const e=new rt(t);this.boardView.updatePosition(e.board())}_handleKeyboard(t){if(this.state.phase!=="setup"&&this.history.length!==0)switch(t.key){case"ArrowLeft":t.preventDefault(),this._navigateHistory("back");break;case"ArrowRight":t.preventDefault(),this._navigateHistory("forward");break;case"Home":t.preventDefault();{const e=this.history.goToStart();e&&this._showPositionFromFen(e),this.moveList.render(this.history),this.analysisGraph.visible&&this.analysisGraph.setHighlight(this.history.getCurrentViewIndex())}break;case"End":t.preventDefault(),this.history.goToEnd(),this.boardView.updatePosition(this.state.board),this.moveList.render(this.history),this.analysisGraph.visible&&this.analysisGraph.setHighlight(this.history.getCurrentViewIndex());break}}_buildPlayerInfo(t){const e=document.createElement("div");e.className=`player-info ${t}`,e.style.display="none";const s=document.createElement("div");s.className="player-avatar";const i=document.createElement("span");return i.className="player-name",e.appendChild(s),e.appendChild(i),e}_updatePlayerInfos(){const t=this.state.playerColor==="w",e=this.state.difficulty,s=this._playerInfo.querySelector(".player-avatar"),i=this._playerInfo.querySelector(".player-name");s.textContent=t?"W":"B",s.className=`player-avatar ${t?"white-piece":"black-piece"}`,i.textContent="You";const n=this._opponentInfo.querySelector(".player-avatar"),a=this._opponentInfo.querySelector(".player-name");n.textContent=t?"B":"W",n.className=`player-avatar ${t?"black-piece":"white-piece"}`,a.textContent=`Stockfish (Level ${e})`,this._playerInfo.style.display="flex",this._opponentInfo.style.display="flex"}_setTimeout(t,e){const s=setTimeout(()=>{this._pendingTimeouts=this._pendingTimeouts.filter(i=>i!==s),t()},e);return this._pendingTimeouts.push(s),s}_clearPendingTimeouts(){for(const t of this._pendingTimeouts)clearTimeout(t);this._pendingTimeouts=[]}destroy(){this._clearPendingTimeouts(),document.removeEventListener("keydown",this._boundKeyboard),this.boardView.destroy(),this.evalBar.destroy(),this.engine.destroy()}_getPieceAt(t){const e=this.state.board,s=t.charCodeAt(0)-97,n=7-(parseInt(t[1])-1);return e[n][s]}_updateCheckHighlight(){if(this.state.isCheck()){const t=this.state.board,e=this.state.turn;for(let s=0;s<8;s++)for(let i=0;i<8;i++){const n=t[s][i];if(n&&n.type==="k"&&n.color===e){const a=String.fromCharCode(97+i)+(8-s);this.boardView.setCheck(a);return}}}else this.boardView.setCheck(null)}_openSettings(){this.settingsDialog.show(this.settings)}_saveGame(){const t=this.state.serialize(this.history);localStorage.setItem("claude-chess-save",JSON.stringify(t)),console.log("Game saved")}_loadGame(){const t=localStorage.getItem("claude-chess-save");if(!t){console.log("No saved game found");return}try{const e=JSON.parse(t),s=this.state.deserialize(e);s&&this.history.deserialize(s),this.setupScreen.hide(),this.boardView.renderPosition(this.state.board,this.state.playerColor),this.evalBar.setPlayerColor(this.state.playerColor),this.evalBar.reset(),this.moveList.render(this.history),this._leftPanelEl.style.display="flex",this._hintBtnEl.style.display=this.state.phase==="over"?"none":"block",this._takeBackBtnEl.style.display=this.state.phase==="over"?"none":"block",this._resignBtnEl.style.display=this.state.phase==="over"?"none":"block",this._takeBackBtnEl.disabled=this.history.length===0,this._replayEl.style.display=this.state.phase==="over"?"flex":"none",this.engine.setDifficulty(this.state.difficulty),this.state.phase==="playing"&&(this._startAnalysis(),this.state.isPlayerTurn||this._setTimeout(()=>this._makeAIMove(),300))}catch(e){console.error("Failed to load game:",e)}}_loadSettings(){const t=localStorage.getItem("claude-chess-settings");if(t)try{return{...F,...JSON.parse(t)}}catch{}return{...F}}_saveSettings(){localStorage.setItem("claude-chess-settings",JSON.stringify({theme:this.settings.theme,volume:this.settings.volume,soundEnabled:this.settings.soundEnabled,playerColor:this.settings.playerColor,difficulty:this.settings.difficulty}))}}const Js=new Xs;Js.init().catch(h=>{console.error("Failed to initialize game:",h)});
